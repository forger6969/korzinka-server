<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Ñ–æ–Ω–¥–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* ========== BASE STYLES ========== */
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: "Segoe UI", Roboto, sans-serif; }
    body { background-color: #1e1e1e; color: #e5e5e5; padding: 20px; }
    h1 { text-align: center; margin-bottom: 20px; font-size: 28px; color: #fff; }

    /* ========== FUND INFO ========== */
    .fund {
      background: #2a2a2a;
      padding: 15px 20px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 20px;
      text-align: center;
      margin-bottom: 25px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.5);
    }

    /* ========== REQUEST CARD ========== */
    .request {
      background: #252525;
      padding: 20px;
      border-radius: 16px;
      margin-bottom: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      transition: transform 0.2s, background 0.2s;
    }
    .request:hover { transform: translateY(-3px); background: #2c2c2c; }
    .request p { margin-bottom: 10px; font-size: 16px; }
    .request p span { font-weight: 600; }

    /* ========== BUTTONS ========== */
    .buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
    .buttons button {
      flex: 1;
      padding: 10px 15px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: transform 0.1s, box-shadow 0.1s;
      color: #fff;
    }
    .buttons button:hover { transform: translateY(-2px); box-shadow: 0 3px 6px rgba(0,0,0,0.4); }
    .approve { background-color: #1d9d63; }
    .approve:hover { background-color: #21b36a; }
    .reject { background-color: #d32f2f; }
    .reject:hover { background-color: #e53935; }

    /* ========== NO REQUESTS MESSAGE ========== */
    .empty {
      text-align: center;
      font-size: 18px;
      margin-top: 50px;
      color: #aaa;
    }

    /* ========== SCROLLABLE LIST ========== */
    #requestsContainer {
      max-height: 70vh;
      overflow-y: auto;
      padding-right: 10px;
    }
    #requestsContainer::-webkit-scrollbar { width: 8px; }
    #requestsContainer::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
    #requestsContainer::-webkit-scrollbar-track { background: #1e1e1e; }
  </style>
</head>
<body>
  <h1>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Ñ–æ–Ω–¥–∞</h1>
  <div class="fund">üí∞ –°—É–º–º–∞ –≤ —Ñ–æ–Ω–¥–µ: <span id="fundAmount">...</span> —Å—É–º</div>
  <div id="requestsContainer"></div>

  <script>
    const tg = window.Telegram.WebApp;
    const API_URL = 'https://korzinka-server.onrender.com';

    let requests = [];
    let fundAmount = 0;

    async function fetchFundAndRequests() {
      // 1. –ü–æ–ª—É—á–∞–µ–º —Ñ–æ–Ω–¥
      const statsRes = await fetch(`${API_URL}/donations/stats`);
      const stats = await statsRes.json();
      const completedRequestsRes = await fetch(`${API_URL}/help-requests?status=completed`);
      const completedRequestsData = await completedRequestsRes.json();
      const used = completedRequestsData.requests.reduce((acc, r) => acc + r.amount, 0);
      fundAmount = stats.totalAmount - used;
      document.getElementById('fundAmount').textContent = fundAmount.toLocaleString();

      // 2. –ü–æ–ª—É—á–∞–µ–º pending –∑–∞—è–≤–∫–∏
      const reqRes = await fetch(`${API_URL}/help-requests?status=pending`);
      const data = await reqRes.json();
      requests = data.requests;
      renderRequests();
    }

    function renderRequests() {
      const container = document.getElementById('requestsContainer');
      container.innerHTML = '';

      if (requests.length === 0) {
        container.innerHTML = '<p class="empty">üì≠ –ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –∑–∞—è–≤–æ–∫</p>';
        return;
      }

      requests.forEach((req, index) => {
        const div = document.createElement('div');
        div.className = 'request';
        div.innerHTML = `
          <p>üë§ <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</span> ${req.userName}</p>
          <p>üí∞ <span>–°—É–º–º–∞:</span> ${req.amount.toLocaleString()} —Å—É–º</p>
          <p>üìù <span>–ü—Ä–∏—á–∏–Ω–∞:</span> ${req.reason}</p>
          <div class="buttons">
            <button class="approve">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</button>
            <button class="reject">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
          </div>
        `;
        container.appendChild(div);

        div.querySelector('.approve').onclick = () => handleApproval(req._id, index);
        div.querySelector('.reject').onclick = () => handleRejection(req._id, index);
      });
    }

    async function handleApproval(requestId, index) {
      const res = await fetch(`${API_URL}/help-requests/${requestId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'approved', approvedBy: 'Admin' })
      });
      const data = await res.json();
      if (data.error) {
        alert(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`);
      } else {
        // —É–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∏–∑ —Å–ø–∏—Å–∫–∞
        requests.splice(index, 1);
        fundAmount -= data.request.amount;
        document.getElementById('fundAmount').textContent = fundAmount.toLocaleString();
        renderRequests();
      }
    }

    async function handleRejection(requestId, index) {
      const reason = prompt('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è:', '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º');
      if (!reason) return;
      const res = await fetch(`${API_URL}/help-requests/${requestId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'rejected', approvedBy: 'Admin', rejectionReason: reason })
      });
      const data = await res.json();
      if (data.error) {
        alert(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`);
      } else {
        // —É–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∏–∑ —Å–ø–∏—Å–∫–∞
        requests.splice(index, 1);
        renderRequests();
      }
    }

    fetchFundAndRequests();
  </script>
</body>
</html>
