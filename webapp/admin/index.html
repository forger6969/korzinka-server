<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

    <header class="bg-blue-600 text-white p-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold">Admin Panel</h1>
        <div>
            <span id="fund-status" class="mr-4">üí∞ –§–æ–Ω–¥: 0 —Å—É–º</span>
            <span id="total-donations">üìà –í—Å–µ–≥–æ —Å–æ–±—Ä–∞–Ω–æ: 0 —Å—É–º</span>
        </div>
    </header>

    <main class="p-6">
        <section class="mb-6">
            <h2 class="text-xl font-semibold mb-4">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ñ–æ–Ω–¥–∞</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="font-semibold">–î–æ—Å—Ç—É–ø–Ω–æ –≤ —Ñ–æ–Ω–¥–µ</h3>
                    <p id="available-funds" class="text-2xl mt-2">0 —Å—É–º</p>
                </div>
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="font-semibold">–û–±—â–∏–µ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è</h3>
                    <p id="total-donations-card" class="text-2xl mt-2">0 —Å—É–º</p>
                </div>
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="font-semibold">–û–∂–∏–¥–∞—é—â–∏–µ –∑–∞—è–≤–∫–∏</h3>
                    <p id="pending-requests" class="text-2xl mt-2">0</p>
                </div>
            </div>
        </section>

        <section>
            <h2 class="text-xl font-semibold mb-4">–ó–∞—è–≤–∫–∏ –Ω–∞ –ø–æ–º–æ—â—å</h2>
            <table class="min-w-full bg-white rounded shadow overflow-hidden">
                <thead class="bg-gray-200">
                    <tr>
                        <th class="px-4 py-2">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                        <th class="px-4 py-2">–°—É–º–º–∞</th>
                        <th class="px-4 py-2">–ü—Ä–∏—á–∏–Ω–∞</th>
                        <th class="px-4 py-2">–°—Ç–∞—Ç—É—Å</th>
                        <th class="px-4 py-2">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="requests-table">
                    <!-- –¢—É—Ç –±—É–¥—É—Ç –∑–∞—è–≤–∫–∏ -->
                </tbody>
            </table>
        </section>
    </main>

<script>
const API_BASE = 'https://korzinka-server.onrender.com';

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—É–º
const formatSum = (sum) => sum.toLocaleString() + ' —Å—É–º';

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–π
async function loadStats() {
    const res = await fetch(`${API_BASE}/donations/stats`);
    const data = await res.json();

    document.getElementById('fund-status').textContent = `üí∞ –§–æ–Ω–¥: ${formatSum(data.totalAmount - data.topDonors.reduce((a,b)=>a+b.totalDonated,0))}`;
    document.getElementById('available-funds').textContent = formatSum(data.totalAmount - data.topDonors.reduce((a,b)=>a+b.totalDonated,0));
    document.getElementById('total-donations-card').textContent = formatSum(data.totalAmount);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫ –Ω–∞ –ø–æ–º–æ—â—å
async function loadRequests() {
    const res = await fetch(`${API_BASE}/help-requests?status=pending`);
    const data = await res.json();

    const table = document.getElementById('requests-table');
    table.innerHTML = '';

    document.getElementById('pending-requests').textContent = data.total;

    data.requests.forEach(req => {
        const tr = document.createElement('tr');
        tr.classList.add('border-b');

        tr.innerHTML = `
            <td class="px-4 py-2">${req.userName}</td>
            <td class="px-4 py-2">${formatSum(req.amount)}</td>
            <td class="px-4 py-2">${req.reason}</td>
            <td class="px-4 py-2">${req.status}</td>
            <td class="px-4 py-2 flex gap-2">
                <button class="approve bg-green-500 text-white px-3 py-1 rounded" data-id="${req._id}">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</button>
                <button class="reject bg-red-500 text-white px-3 py-1 rounded" data-id="${req._id}">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
            </td>
        `;

        table.appendChild(tr);
    });

    // –í–µ—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫–∏
    document.querySelectorAll('.approve').forEach(btn => {
        btn.addEventListener('click', () => handleRequest(btn.dataset.id, 'approved'));
    });
    document.querySelectorAll('.reject').forEach(btn => {
        const reason = prompt('–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏ (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º)');
        btn.addEventListener('click', () => handleRequest(btn.dataset.id, 'rejected', reason));
    });
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∏—è/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
async function handleRequest(id, status, reason = '') {
    const body = status === 'rejected' ? { status, rejectionReason: reason } : { status, approvedBy: 'admin' };
    await fetch(`${API_BASE}/help-requests/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
    });
    await loadStats();
    await loadRequests();
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
loadStats();
loadRequests();
</script>

</body>
</html>
